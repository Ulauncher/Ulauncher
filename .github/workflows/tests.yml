name: Tests

on:
  pull_request:
    branches:
      - v5
      - v6
  push:
    branches:
      - '*'
  create:
    tags:
      - '*'

jobs:
  tests:
    runs-on: ubuntu-latest
    # Use build-image v6.3 for v5 test runs, otherwise Github Actions 'Post Checkout' stage fails wanting GLIBC_2.28,
    # which cannot be installed on Ubuntu 18.04.
    # Upgrading the base image for v5 builds is not an efficient spend of time in light of (hopefully) upcoming v6 release.
    container: ulauncher/build-image:6.3
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Tests
        run: |
          # restore dependencies needed for v5
          pip install -r requirements.txt
          apt update && apt install -y gir1.2-notify-0.7 gir1.2-keybinder-3.0 python3-pyinotify python3-levenshtein gir1.2-keybinder-3.0 python3-websocket

          flake8 .
          mypy .
          pylint ulauncher
          DISPLAY=:1 xvfb-run pytest tests
      - name: Build docs
        run: |
          cd docs
          sphinx-apidoc -d 5 -o source ../ulauncher
          make html
          cd -
      - name: Build preferences
        run: ./ul build-preferences --skip-if-built
